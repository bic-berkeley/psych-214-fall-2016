<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Applying deformations exercise &mdash; Functional MRI methods</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/copybutton.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Functional MRI methods" href="index.html" />
    <link rel="next" title="Applying deformations exercise" href="applying_deformations_exercise.html" />
    <link rel="prev" title="General resampling between images with scipy.ndimage.map_coordinates" href="map_coordinates.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p><span class="math">\(\newcommand{L}[1]{\| #1 \|}\newcommand{VL}[1]{\L{ \vec{#1} }}\newcommand{R}[1]{\operatorname{Re}\,(#1)}\newcommand{I}[1]{\operatorname{Im}\, (#1)}\)</span></p>
<div class="section" id="applying-deformations-exercise">
<h1>Applying deformations exercise<a class="headerlink" href="#applying-deformations-exercise" title="Permalink to this headline">¶</a></h1>
<p>Requirements:</p>
<ul class="simple">
<li><a class="reference internal" href="numpy_squeeze.html"><span class="doc">Removing length 1 axes with numpy.squeeze</span></a>;</li>
<li><a class="reference internal" href="numpy_transpose.html"><span class="doc">numpy.tranpose for swapping axes</span></a>;</li>
<li><a class="reference internal" href="resampling_with_ndimage.html"><span class="doc">Resampling with scipy.ndimage</span></a>;</li>
<li><a class="reference internal" href="nibabel_affines.html"><span class="doc">The nibabel.affines module</span></a>;</li>
<li><a class="reference internal" href="map_coordinates.html"><span class="doc">General resampling between images with scipy.ndimage.map_coordinates</span></a>.</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: standard imports</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># print arrays to 4 decimal places</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="kn">as</span> <span class="nn">npl</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">nibabel</span> <span class="kn">as</span> <span class="nn">nib</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: gray colormap and nearest neighbor interpolation by default</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>
</pre></div>
</div>
<div class="section" id="applying-a-deformation-field">
<h2>Applying a deformation field<a class="headerlink" href="#applying-a-deformation-field" title="Permalink to this headline">¶</a></h2>
<p>We should have already calculated the deformation field for the image
<code class="docutils literal"><span class="pre">ds107_sub012_highres.nii</span></code>.</p>
<p>We did this using the SPM12 <code class="docutils literal"><span class="pre">Normalise:</span> <span class="pre">Estimate</span></code> option from the GUI.</p>
<p>This should have left an image called <code class="docutils literal"><span class="pre">y_ds107_sub012_highres.nii</span></code> in
your working directory.</p>
<p>If not:</p>
<ul class="simple">
<li>Ask for help;</li>
<li>If you get stuck, you can download the image from
<a class="reference download internal" href="_downloads/y_ds107_sub012_highres.nii" download=""><code class="xref download docutils literal"><span class="pre">y_ds107_sub012_highres.nii</span></code></a>.</li>
</ul>
<p>We make an image object for this deformations image by loading with nibabel.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: load y_ds107_sub012_highres.nii with nibabel</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># get the image array data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">deformations_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;y_ds107_sub012_highres.nii&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">deformations_data</span> <span class="o">=</span> <span class="n">deformations_img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">deformations_data</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(121, 145, 121, 1, 3)</span>
</pre></div>
</div>
<p>We are going to work out how to apply this <em>deformations</em> image to reslice our
original image <a class="reference download internal" href="_downloads/ds107_sub012_highres.nii" download=""><code class="xref download docutils literal"><span class="pre">ds107_sub012_highres.nii</span></code></a>.</p>
<p>Oddly - this is a 5 dimensional image, where the 4th dimension is length 1.</p>
<p>The length-1 4th dimension is an artefact of the <a class="reference external" href="http://nifti.nimh.nih.gov/nifti-1">NIfTI image format</a> – so let&#8217;s get rid of this dimension with <a href="#id1"><span class="problematic" id="id2">:doc:`np.squeeze
&lt;numpy_squeeze&gt;`_</span></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: remove length-1 4th dimension from deformation data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">deformations_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">deformations_data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">deformations_data</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(121, 145, 121, 3)</span>
</pre></div>
</div>
<p>The data is now a 4-dimensional image, containing 3 volumes. These volumes
are:</p>
<ul class="simple">
<li>x coordinates;</li>
<li>y coordinates;</li>
<li>z coordinates</li>
</ul>
<p>respectively.</p>
<p>Put another way, the vector <code class="docutils literal"><span class="pre">deformations_data[i,</span> <span class="pre">j,</span> <span class="pre">k,</span> <span class="pre">:]</span></code> gives the (x, y,
z) coordinates for the voxel <code class="docutils literal"><span class="pre">[i,</span> <span class="pre">j,</span> <span class="pre">k]</span></code>. More on this later.</p>
<p>If you were looking carefully at the SPM interface, SPM has calculated the
distortions necessary to go from a template of <em>tissue probability maps</em>
(called <code class="docutils literal"><span class="pre">TPM.nii</span></code>) to the <code class="docutils literal"><span class="pre">ds107_sub012_highres.nii</span></code> image.</p>
<p>We can get the original 3D shape and affine of <code class="docutils literal"><span class="pre">TPM.nii</span></code> because SPM stored
them in <code class="docutils literal"><span class="pre">y_ds107_sub012_highres.nii</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: get original TPM.nii 3D shape and affine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tpm_shape</span> <span class="o">=</span> <span class="n">deformations_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tpm_affine</span> <span class="o">=</span> <span class="n">deformations_img</span><span class="o">.</span><span class="n">affine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tpm_affine</span>
<span class="go">array([[  -1.5,    0. ,    0. ,   90. ],</span>
<span class="go">       [   0. ,    1.5,    0. , -126. ],</span>
<span class="go">       [   0. ,    0. ,    1.5,  -72. ],</span>
<span class="go">       [   0. ,    0. ,    0. ,    1. ]])</span>
</pre></div>
</div>
<p>First we look at the images before the normalization has been applied.</p>
<p>To do that, we will make a new copy of the MNI template, with the same shape
as the TPM image.</p>
<p>The MNI template image we will use is
<a class="reference download internal" href="_downloads/mni_icbm152_t1_tal_nlin_asym_09a.nii" download=""><code class="xref download docutils literal"><span class="pre">mni_icbm152_t1_tal_nlin_asym_09a.nii</span></code></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: load the template image we will resample from</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">template_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;mni_icbm152_t1_tal_nlin_asym_09a.nii&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">template_data</span> <span class="o">=</span> <span class="n">template_img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">template_data</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(197, 233, 189)</span>
</pre></div>
</div>
<p>Now we need the mapping from voxels in <code class="docutils literal"><span class="pre">TPM.nii</span></code> to voxels in
<code class="docutils literal"><span class="pre">mni_icbm152_t1_tal_nlin_asym_09a.nii</span></code>.</p>
<p>We can break this down into two transforms:</p>
<ul class="simple">
<li>from voxels in <code class="docutils literal"><span class="pre">TPM.nii</span></code> to (x, y, z) mm;</li>
<li>from (x, y, z) mm to voxels in <code class="docutils literal"><span class="pre">mni_icbm152_t1_tal_nlin_asym_09a.nii</span></code>.</li>
</ul>
<p>We have these transforms already. The full transform is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: voxels in TPM.nii to voxels in mni_icbm152_t1_tal_nlin_asym_09a.nii</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Matrix multiplication is right to left</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vox2vox</span> <span class="o">=</span> <span class="n">npl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tpm_affine</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vox2vox</span>
<span class="go">array([[  -1.5,    0. ,    0. ,  188. ],</span>
<span class="go">       [   0. ,    1.5,    0. ,    8. ],</span>
<span class="go">       [   0. ,    0. ,    1.5,    0. ],</span>
<span class="go">       [   0. ,    0. ,    0. ,    1. ]])</span>
</pre></div>
</div>
<p>We break this down into the 3 x 3 <code class="docutils literal"><span class="pre">mat</span></code> and length 3 <code class="docutils literal"><span class="pre">vec</span></code> components:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: to mat and vec</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mat</span><span class="p">,</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">affines</span><span class="o">.</span><span class="n">to_matvec</span><span class="p">(</span><span class="n">vox2vox</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mat</span>
<span class="go">array([[-1.5,  0. ,  0. ],</span>
<span class="go">       [ 0. ,  1.5,  0. ],</span>
<span class="go">       [ 0. ,  0. ,  1.5]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vec</span>
<span class="go">array([ 188.,    8.,    0.])</span>
</pre></div>
</div>
<p>Then we resample from the MNI template, into the voxel grid of the
<code class="docutils literal"><span class="pre">TPM.nii</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: resample MNI template onto TPM grid</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">affine_transform</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">template_into_tpm</span> <span class="o">=</span> <span class="n">affine_transform</span><span class="p">(</span><span class="n">template_data</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span>
<span class="gp">... </span>                                     <span class="n">output_shape</span><span class="o">=</span><span class="n">tpm_shape</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">template_into_tpm</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(121, 145, 121)</span>
</pre></div>
</div>
<p>Here is the new version of the template image:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: plot the template image resampled onto the TPM grid</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">template_into_tpm</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">60</span><span class="p">])</span>
<span class="go">&lt;...&gt;</span>
</pre></div>
</div>
<p>(<a class="reference external" href=".//applying_deformations_solution-11.png">png</a>, <a class="reference external" href=".//applying_deformations_solution-11.hires.png">hires.png</a>, <a class="reference external" href=".//applying_deformations_solution-11.pdf">pdf</a>)</p>
<div class="figure">
<img alt="_images/applying_deformations_solution-11.png" src="_images/applying_deformations_solution-11.png" />
</div>
<p>Now, what to do with with the SPM distortion field in <code class="docutils literal"><span class="pre">deformations_data</span></code>?</p>
<p>By checking in the SPM source code <a class="footnote-reference" href="#spm-deform-detective" id="id3">[1]</a>, it is possible to
work out that <code class="docutils literal"><span class="pre">deformations_data</span></code> contains, for every voxel in TPM, the
corresponding mm coordinate in the <em>mm space</em> of the subject image.</p>
<p>That is, <code class="docutils literal"><span class="pre">deformations_data[i,</span> <span class="pre">j,</span> <span class="pre">k]</span></code> is a length 3 vector <code class="docutils literal"><span class="pre">[x,</span> <span class="pre">y,</span> <span class="pre">z]</span></code>
where <code class="docutils literal"><span class="pre">[x,</span> <span class="pre">y,</span> <span class="pre">z]</span></code> are the mm coordinates of voxel <code class="docutils literal"><span class="pre">[i,</span> <span class="pre">j,</span> <span class="pre">k]</span></code> when mapped
into millimeters for the subject image.</p>
<p>Here is the subject data, and the image, which contains the affine:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#: load the subject data that we will resample from</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">subject_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;ds107_sub012_highres.nii&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">subject_data</span> <span class="o">=</span> <span class="n">subject_img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">subject_data</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(256, 208, 192)</span>
</pre></div>
</div>
<p>With this information, and with the <code class="docutils literal"><span class="pre">scipy.ndimage.map_coordinates</span></code>
function, you should be able to:</p>
<ul class="simple">
<li>get the mapping from voxels in TPM to voxels in the subject image and;</li>
<li>resample the subject image into the grid of the TPM image using this
mapping.</li>
</ul>
<p>Hint: remember that <a class="reference internal" href="map_coordinates.html"><span class="doc">map_coordinates</span></a> expects the
3-length coordinate dimension to be first, but <code class="docutils literal"><span class="pre">deformations_data</span></code> – at
the moment – has the 3-length coordinate dimension last.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#- * get mapping from voxels in TPM to voxels in the subject image;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1">#- * resample the subject image into the grid of the TPM image using</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1">#-   this mapping.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">map_coordinates</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vox2vox_mapping</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">affines</span><span class="o">.</span><span class="n">apply_affine</span><span class="p">(</span><span class="n">npl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">subject_img</span><span class="o">.</span><span class="n">affine</span><span class="p">),</span> <span class="n">deformations_data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">for_map_coords</span> <span class="o">=</span> <span class="n">vox2vox_mapping</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">subject_into_tpm</span> <span class="o">=</span> <span class="n">map_coordinates</span><span class="p">(</span><span class="n">subject_data</span><span class="p">,</span> <span class="n">for_map_coords</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">subject_into_tpm</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(121, 145, 121)</span>
</pre></div>
</div>
<p>Show an example slice from the template resampled into the TPM voxel grid, and the subject
resampled into the TPM voxel grid:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">#- show an example slice from the resampled template and resampled</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1">#- subject</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">template_into_tpm</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">60</span><span class="p">])</span>
<span class="go">&lt;...&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">subject_into_tpm</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">60</span><span class="p">])</span>
<span class="go">&lt;...&gt;</span>
</pre></div>
</div>
<p>(<a class="reference external" href=".//applying_deformations_solution-14.png">png</a>, <a class="reference external" href=".//applying_deformations_solution-14.hires.png">hires.png</a>, <a class="reference external" href=".//applying_deformations_solution-14.pdf">pdf</a>)</p>
<div class="figure">
<img alt="_images/applying_deformations_solution-14.png" src="_images/applying_deformations_solution-14.png" />
</div>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="spm-deform-detective" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>It&#8217;s not very easy to work through the SPM12 source
code for this, but if you want to check for yourself, you&#8217;ll find that the
SPM batch interface for &#8220;Normalise: Write&#8221; is in <a class="reference external" href="https://bitbucket.org/matthewbrett/spm12/src/ec9cae02ebf8bb367ba71e2782e2be1a77a67e28/config/spm_run_norm.m?at=master&amp;fileviewer=file-view-default#spm_run_norm.m-29">config/spm_run_norm.m</a>.
The batch interface calls the sub-function <a class="reference external" href="https://bitbucket.org/matthewbrett/spm12/src/ec9cae02ebf8bb367ba71e2782e2be1a77a67e28/config/spm_run_norm.m?at=master&amp;fileviewer=file-view-default#spm_run_norm.m-77">norm_write</a>.
<code class="docutils literal"><span class="pre">norm_write</span></code> collects the NIfTI file with the <code class="docutils literal"><span class="pre">y_</span></code> prefix that contains
the deformations, if the user did not specify the file, and calls the
<code class="docutils literal"><span class="pre">spm_deformations</span></code> function.  This function in turn calls down into the
<a class="reference external" href="https://bitbucket.org/matthewbrett/spm12/src/ec9cae02ebf8bb367ba71e2782e2be1a77a67e28/spm_deformations.m?at=master&amp;fileviewer=file-view-default#spm_deformations.m-360">pull_def</a>
sub-function, in which SPM calculates the matrix <code class="docutils literal"><span class="pre">Y</span></code>, which is the (I, J,
K, 3) image data from the deformations NIfTI file, left multiplied by the
mm to voxel mapping for the image being resampled.  <code class="docutils literal"><span class="pre">pull_def</span></code> then
resamples from the image to which we are applying &#8220;Normalize: Write&#8221;, using
the <code class="docutils literal"><span class="pre">Y</span></code> array as voxel coordinates.  Therefore the <code class="docutils literal"><span class="pre">y_</span></code>-prefixed
deformation field image contains the coodinates mapping from voxels in the
template to millimeters in the image that was registered.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">PSYCH 214 Fall 2016</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="syllabus.html">Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="preparation.html">Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="logistics.html">Logistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="classes.html">Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="labs.html">Labs</a></li>
<li class="toctree-l1"><a class="reference internal" href="projects.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="topics.html">Course material by topic</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercises.html">Exercises and homework</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_data.html">Example datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="_downloads">Website downloads</a></li>
    
    <li class="toctree-l1"><a href="https://nipy.bic.berkeley.edu/psych-214">Dataset downloads</a></li>
    
    <li class="toctree-l1"><a href="https://github.com/psych-214-fall-2016">Github organization</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="map_coordinates.html" title="previous chapter">General resampling between images with <code class="docutils literal"><span class="pre">scipy.ndimage.map_coordinates</span></code></a></li>
      <li>Next: <a href="applying_deformations_exercise.html" title="next chapter">Applying deformations exercise</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Matthew Brett, JB Poline.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/applying_deformations_solution.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>